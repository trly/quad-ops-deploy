services:
  pki:
    image: docker.io/smallstep/step-ca:latest
    restart: always
    volumes:
    - certificate-authority:/home/step
    networks:
    - default
    - pki

    x-podman-env-secrets:
      step-ca-password: DOCKER_STEPCA_INIT_PASSWORD

  keycloak:
    image: quay.io/keycloak/keycloak:26.2.4
    restart: always
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_HOSTNMAE: keycloak.localhost
      KC_HOSTNAME_PORT: 8443
      KC_HOSTNAME_URL: keycloak.localhost:8443
      KC_HOSTNAME_ADMIN_URL: keycloak.localhost:8443
      PROXY_ADDRESS_FORWARDING: "true"
    command: start-dev
    depends_on:
      - pki
    networks:
      - default
      - proxy
      - pki
    x-podman-env-secrets:
        keycloak-bootstrap-password: KC_BOOTSTRAP_ADMIN_PASSWORD


  reverse-proxy:
    image: 'docker.io/library/caddy:2.10.0'
    restart: always
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:z
    ports:
      - '8080:80'
      - '8443:443'

    depends_on:
      - pki

    networks:
      - default
      - proxy
      - pki

volumes:
  certificate-authority:

secrets:
  step-ca-password:
    external: true
  keycloak-bootstrap-password:
    external: true

networks:
  default:
  pki:
  proxy:
