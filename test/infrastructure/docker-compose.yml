services:
  pki:
    image: docker.io/smallstep/step-ca:latest
    restart: always
    volumes:
    - certificate-authority:/home/step
    networks:
    - default
    - pki

    x-podman-env-secrets:
      step-ca-password: DOCKER_STEPCA_INIT_PASSWORD

  keycloak:
    image: quay.io/keycloak/keycloak:26.2.4
    restart: always
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
    command: start-dev
    depends_on:
      - pki
    networks:
      - default
      - proxy
      - pki
    x-podman-env-secrets:
        keycloak-bootstrap-password: KC_BOOTSTRAP_ADMIN_PASSWORD


  reverse-proxy:
    image: 'docker.io/jc21/nginx-proxy-manager:latest'
    restart: always
    ports:
      - '8880:80'
      - '8843:443'
      - '8081:81'

    depends_on:
      - pki

    environment: {}

    volumes:
      - reverse-proxy:/data
      - letsencrypt:/etc/letsencrypt

    networks:
      - default
      - proxy
      - pki
volumes:
  reverse-proxy:
  certificate-authority:
  letsencrypt:

secrets:
  step-ca-password:
    external: true
  keycloak-bootstrap-password:
    external: true

networks:
  default:
  pki:
  proxy:
